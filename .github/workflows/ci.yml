name: CI/CD Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
  # schedule:
  #   - cron: '21 13 * * 0'

jobs:
  # --- 1. CODE QUALITY (JUST/UV/NODE) ---
  checks:
    name: Run Just Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install just
        uses: taiki-e/install-action@just

      - name: Setup uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22.x'
          cache: npm

      - name: Install dependencies
        run: just install-deps

      - name: Run checks
        run: just check

  # --- 2. SECURITY (CODEQL) ---
  analyze:
    name: CodeQL Analyze (${{ matrix.language }})
    runs-on: ${{ (matrix.language == 'swift' && 'macos-latest') || 'ubuntu-latest' }}
    permissions:
      security-events: write
      packages: read
      actions: read
      contents: read

    strategy:
      fail-fast: false
      matrix:
        include:
          - language: actions
            build-mode: none
          - language: javascript-typescript
            build-mode: none
          - language: python
            build-mode: none

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: ${{ matrix.language }}
          build-mode: ${{ matrix.build-mode }}

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:${{matrix.language}}"

  # --- 3. TERRAFORM VALIDATION (Conditional) ---
  terraform-validate:
    name: Terraform Validate
    runs-on: ubuntu-latest
    # This job provides an output so 'deploy' knows if it should run
    outputs:
      run_deploy: ${{ steps.filter.outputs.terraform }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for Terraform Changes
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            terraform:
              - 'terraform/**'

      - name: Setup Terraform
        if: steps.filter.outputs.terraform == 'true'
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init & Validate
        if: steps.filter.outputs.terraform == 'true'
        working-directory: terraform
        run: |
          terraform init -backend=false
          terraform fmt -check -recursive
          terraform validate

  # --- 4. DEPLOYMENT (Only on Main) ---
  deploy:
    name: Terraform Apply
    needs: [checks, analyze, terraform-validate]
    # Only run if:
    # 1. We are on the main branch
    # 2. It's a push (not a PR or Schedule)
    # 3. Terraform files actually changed
    if: |
      github.ref == 'refs/heads/main' &&
      github.event_name == 'push' &&
      needs.terraform-validate.outputs.run_deploy == 'true'
    runs-on: ubuntu-latest
    environment: production # Highly recommended for secrets management
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        working-directory: terraform
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}" \
            -backend-config="key=prod/terraform.tfstate" \
            -backend-config="region=us-east-1"

      - name: Terraform Apply
        working-directory: terraform
        run: terraform apply -auto-approve
